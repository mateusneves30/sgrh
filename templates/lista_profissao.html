{% extends 'base.html' %}

{% block title %}Lista de Profissões - SGRH{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Lista de Profissões</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProfissao">+ Adicionar Profissão
        </button>
    </div>

    {% if profissoes %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Título</th>
                    <th>Descrição</th>
                    <th>Salário Base</th>
                </tr>
                </thead>
                <tbody id="tabelaProfissoes">
                {% for profissao in profissoes %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ profissao.titulo }}</td>
                        <td>{{ profissao.descricao if profissao.descricao else 'N/A' }}</td>
                        <td>R$ {{ "%.2f"|format(profissao.salario_base) }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            Nenhuma profissão cadastrada.
        </div>
    {% endif %}

    <!-- Modal Adicionar Profissão -->
    <div class="modal fade" id="modalProfissao" tabindex="-1" aria-labelledby="modalProfissaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProfissaoLabel">Adicionar Profissão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formProfissao" data-url="{{ url_for('form_profissao') }}">
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título</label>
                            <input type="text" class="form-control" id="titulo" name="titulo" required>
                        </div>
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricao" name="descricao"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="salario_base" class="form-label">Salário Base</label>
                            <input type="number" step="0.01" class="form-control" id="salario_base" name="salario_base"
                                   required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("formProfissao").addEventListener("submit", function (event) {
            event.preventDefault();

            let form = this;
            let formData = new FormData(form);
            let url = form.getAttribute("data-url");  // Obtendo a URL correta

            fetch(url, {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let tabela = document.getElementById("tabelaProfissoes");

                        // Se a tabela não existir, cria uma nova
                        if (!tabela) {
                            let tabelaContainer = document.createElement("div");
                            tabelaContainer.className = "table-responsive";
                            tabelaContainer.innerHTML = `
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Título</th>
                                            <th>Descrição</th>
                                            <th>Salário Base</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProfissoes">
                                    </tbody>
                                </table>
                             `;
                            document.querySelector(".alert-warning")?.remove();  // Remove a mensagem "Nenhuma profissão cadastrada."
                            document.querySelector("h3").after(tabelaContainer);  // Insere após o título "Lista de Profissões"
                            tabela = document.getElementById("tabelaProfissoes");
                        }

                        let novaLinha = `<tr>
                <td>${data.id}</td>
                <td>${data.titulo}</td>
                <td>${data.descricao || 'N/A'}</td>
                <td>R$ ${parseFloat(data.salario_base).toFixed(2)}</td>
            </tr>`;
                        tabela.innerHTML += novaLinha;

                        form.reset();
                        let modal = bootstrap.Modal.getInstance(document.getElementById("modalProfissao"));
                        modal.hide();
                    } else {
                        alert("Erro ao cadastrar!");
                    }
                })
                .catch(error => console.error("Erro:", error));
        });
    </script>

{% endblock %}
