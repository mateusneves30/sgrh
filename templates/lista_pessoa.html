{% extends 'base.html' %}

{% block title %}Lista de Pessoas - SGRH{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Lista de Pessoas</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPessoa">+ Adicionar Pessoa</button>
    </div>

    {% if pessoas %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>Data de Nascimento</th>
                    <th>Endereço</th>
                    <th>Profissão</th>
                </tr>
                </thead>
                <tbody id="tabelaPessoas">
                {% for pessoa in pessoas %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ pessoa.nome }}</td>
                        <td>{{ pessoa.cpf }}</td>
                        <td>{{ pessoa.data_nascimento }}</td>
                        <td>{{ pessoa.endereco }}</td>
                        <td>{{ pessoa.profissao.titulo if pessoa.profissao else 'Sem Profissão' }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            Nenhuma pessoa cadastrada.
        </div>
    {% endif %}

    <!-- Modal Adicionar Pessoa -->
    <div class="modal fade" id="modalPessoa" tabindex="-1" aria-labelledby="modalPessoaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPessoaLabel">Adicionar Pessoa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPessoa" data-url="{{ url_for('form_pessoa') }}">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="cpf" class="form-label">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" required>
                        </div>
                        <div class="mb-3">
                            <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" required>
                        </div>
                        <div class="mb-3">
                            <label for="endereco" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="endereco" name="endereco" required>
                        </div>
                        <div class="mb-3">
                            <label for="profissao_id" class="form-label">Profissão</label>
                            <select class="form-select" id="profissao_id" name="profissao_id" required>
                                <option value="" selected disabled>Selecione...</option>
                                {% for profissao in profissoes %}
                                    <option value="{{ profissao.id }}">{{ profissao.titulo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("formPessoa").addEventListener("submit", function (event) {
            event.preventDefault();

            let form = this;
            let formData = new FormData(form);
            let url = form.getAttribute("data-url");

            fetch(url, {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let tabela = document.getElementById("tabelaPessoas");

                        if (!tabela) {
                            let tabelaContainer = document.createElement("div");
                            tabelaContainer.className = "table-responsive";
                            tabelaContainer.innerHTML = `
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Nome</th>
                                            <th>CPF</th>
                                            <th>Data de Nascimento</th>
                                            <th>Endereço</th>
                                            <th>Profissão</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaPessoas"></tbody>
                                </table>
                            `;
                            document.querySelector(".alert-warning")?.remove();
                            document.querySelector("h3").after(tabelaContainer);
                            tabela = document.getElementById("tabelaPessoas");
                        }

                        let novaLinha = `<tr>
                            <td>${data.id}</td>
                            <td>${data.nome}</td>
                            <td>${data.cpf}</td>
                            <td>${data.data_nascimento}</td>
                            <td>${data.endereco}</td>
                            <td>${data.profissao ? data.profissao : 'Sem Profissão'}</td>
                        </tr>`;
                        tabela.innerHTML += novaLinha;

                        document.getElementById("formPessoa").reset();
                        let modal = bootstrap.Modal.getInstance(document.getElementById("modalPessoa"));
                        modal.hide();
                    } else {
                        alert("Erro ao cadastrar: " + data.message);
                    }
                })
                .catch(error => console.error("Erro:", error));
        });
    </script>
{% endblock %}
