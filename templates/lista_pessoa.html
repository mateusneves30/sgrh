{% extends 'base.html' %}

{% block title %}Lista de Pessoas - SGRH{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Lista de Pessoas</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPessoa">+ Adicionar Pessoa</button>
    </div>

    {% if pessoas %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>Data de Nascimento</th>
                    <th>Endereço</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody>
                {% for pessoa in pessoas %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ pessoa.nome }}</td>
                        <td>{{ pessoa.cpf }}</td>
                        <td>{{ pessoa.data_nascimento.strftime('%d/%m/%Y') }}</td>
                        <td>{{ pessoa.endereco }}</td>
                        <td>
                            <button class="btn btn-info" data-bs-toggle="modal"
                                    data-bs-target="#modalDetalhesPessoa{{ pessoa.id }}">Detalhes
                            </button>
                            <button class="btn btn-warning" data-bs-toggle="modal"
                                    data-bs-target="#modalEditarPessoa{{ pessoa.id }}">Editar
                            </button>
                        </td>
                    </tr>

                    <!-- Modal de Detalhes da Pessoa -->
                    <div class="modal fade" id="modalDetalhesPessoa{{ pessoa.id }}" tabindex="-1"
                         aria-labelledby="modalLabel{{ pessoa.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalLabel{{ pessoa.id }}">Detalhes
                                        de {{ pessoa.nome }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <div class="mb-3">
                                        <p><strong>CPF:</strong> {{ pessoa.cpf }}</p>
                                        <p><strong>Data de
                                            Nascimento:</strong> {{ pessoa.data_nascimento.strftime('%d/%m/%Y') }}</p>
                                        <p><strong>Endereço:</strong> {{ pessoa.endereco }}</p>
                                    </div>

                                    <div class="mb-3">
                                        <h6 class="fw-bold mt-3">Profissões:</h6>
                                        <ul class="list-group list-group-flush">
                                            {% for profissao in pessoa.profissoes %}
                                                <li class="list-group-item">{{ profissao.titulo }} - Salário:
                                                    R$ {{ "%.2f"|format(profissao.salario_base) }}</li>
                                            {% else %}
                                                <li class="list-group-item">Sem profissão cadastrada.</li>
                                            {% endfor %}
                                        </ul>
                                        <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal"
                                                data-bs-target="#modalCadastrarProfissao{{ pessoa.id }}">+ Adicionar
                                            Profissão
                                        </button>
                                    </div>

                                    <div class="mb-3">
                                        <h6 class="fw-bold mt-3">Capacitações:</h6>
                                        <ul class="list-group list-group-flush">
                                            {% for capacitacao in pessoa.capacitacoes %}
                                                <li class="list-group-item">{{ capacitacao.titulo }}
                                                    - {{ capacitacao.instituicao }}</li>
                                            {% else %}
                                                <li class="list-group-item">Sem capacitações registradas.</li>
                                            {% endfor %}
                                        </ul>
                                        <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal"
                                                data-bs-target="#modalCadastrarCapacitacao{{ pessoa.id }}">+ Adicionar
                                            Capacitação
                                        </button>
                                    </div>

                                    <div class="mb-3">
                                        <h6 class="fw-bold mt-3">Folhas de Pagamento:</h6>
                                        <ul class="list-group list-group-flush">
                                            {% for folha in pessoa.folhas_pagamento %}
                                                <li class="list-group-item">
                                                    {{ folha.mes_referencia }} - Salário Bruto:
                                                    R$ {{ "%.2f"|format(folha.salario_bruto) }},
                                                    Desconto: R$ {{ "%.2f"|format(folha.descontos) }} - Salário Líquido:
                                                    R$ {{ "%.2f"|format(folha.salario_liquido) }}
                                                </li>
                                            {% else %}
                                                <li class="list-group-item">Sem registros de pagamento.</li>
                                            {% endfor %}
                                        </ul>
                                        <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal"
                                                data-bs-target="#modalCadastrarFolha{{ pessoa.id }}">+ Adicionar Folha
                                            de Pagamento
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalCadastrarProfissao{{ pessoa.id }}" tabindex="-1"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Adicionar Profissão para {{ pessoa.nome }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="{{ url_for('cadastrar_profissao', pessoa_id=pessoa.id) }}"
                                          method="POST">
                                        <div class="mb-3">
                                            <label class="form-label">Título</label>
                                            <input type="text" class="form-control" name="titulo" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Salário Base</label>
                                            <input type="number" step="0.01" class="form-control" name="salario_base"
                                                   required>
                                        </div>
                                        <button type="submit" class="btn btn-success">Salvar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalCadastrarCapacitacao{{ pessoa.id }}" tabindex="-1"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Adicionar Capacitação para {{ pessoa.nome }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="{{ url_for('cadastrar_capacitacao', pessoa_id=pessoa.id) }}"
                                          method="POST">
                                        <div class="mb-3">
                                            <label class="form-label">Título</label>
                                            <input type="text" class="form-control" name="titulo" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Instituição</label>
                                            <input type="text" class="form-control" name="instituicao" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Carga Horária</label>
                                            <input type="number" class="form-control" name="carga_horaria" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Data de Conclusão</label>
                                            <input type="date" class="form-control" name="data_conclusao" required>
                                        </div>
                                        <button type="submit" class="btn btn-success">Salvar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalCadastrarFolha{{ pessoa.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Adicionar Folha de Pagamento para {{ pessoa.nome }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="{{ url_for('cadastrar_folha', pessoa_id=pessoa.id) }}" method="POST">
                                        <div class="mb-3">
                                            <label class="form-label">Mês de Referência</label>
                                            <input type="month" class="form-control" name="mes_referencia" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Salário Bruto</label>
                                            <input type="number" step="0.01" class="form-control" name="salario_bruto"
                                                   required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Descontos</label>
                                            <input type="number" step="0.01" class="form-control" name="descontos"
                                                   required>
                                        </div>
                                        <button type="submit" class="btn btn-success">Salvar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de Edição da Pessoa -->
                    <div class="modal fade" id="modalEditarPessoa{{ pessoa.id }}" tabindex="-1"
                         aria-labelledby="modalEditarLabel{{ pessoa.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalEditarLabel{{ pessoa.id }}">
                                        Editar {{ pessoa.nome }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form action="{{ url_for('editar_pessoa', pessoa_id=pessoa.id) }}" method="POST">
                                        <div class="mb-3">
                                            <label for="nome" class="form-label">Nome</label>
                                            <input type="text" class="form-control" name="nome"
                                                   value="{{ pessoa.nome }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="endereco" class="form-label">Endereço</label>
                                            <input type="text" class="form-control" name="endereco"
                                                   value="{{ pessoa.endereco }}" required>
                                        </div>

                                        <!-- Profissões -->
                                        <div class="mb-3">
                                            <label class="form-label">Profissões</label>
                                            <select class="form-select" name="profissoes" multiple>
                                                {% for profissao in profissoes %}
                                                    <option value="{{ profissao.id }}"
                                                            {% if profissao in pessoa.profissoes %}selected{% endif %}>
                                                        {{ profissao.titulo }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Capacitações -->
                                        <div class="mb-3">
                                            <label class="form-label">Capacitações</label>
                                            <select class="form-select" name="capacitacoes" multiple>
                                                {% for capacitacao in capacitacoes %}
                                                    <option value="{{ capacitacao.id }}"
                                                            {% if capacitacao in pessoa.capacitacoes %}selected{% endif %}>
                                                        {{ capacitacao.titulo }} - {{ capacitacao.instituicao }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Folhas de Pagamento -->
                                        <div class="mb-3">
                                            <label class="form-label">Folhas de Pagamento</label>
                                            <select class="form-select" name="folhas_pagamento" multiple>
                                                {% for folha in folhas_pagamento %}
                                                    <option value="{{ folha.id }}"
                                                            {% if folha in pessoa.folhas_pagamento %}selected{% endif %}>
                                                        {{ folha.mes_referencia }} -
                                                        R$ {{ "%.2f"|format(folha.salario_liquido) }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <button type="submit" class="btn btn-success">Salvar Alterações</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            Nenhuma pessoa cadastrada.
        </div>
    {% endif %}
{% endblock %}
